<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ğŸ€ ä¼šè©±ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --cream: #FBF8F3; --white: #FFFFFF; --peach: #FFF5EE;
  --mint: #F0F7F4; --mint-dark: #5BA88C; --mint-med: #E0F0E8;
  --coral: #E8927C; --coral-light: #FFF0EB;
  --brown: #5C4A3A; --brown-light: #8B7B6B; --brown-pale: #E8E0D6;
  --bubble-a: #DCF0E5; --bubble-b: #FDE8DC;
  --tag-a: #5BA88C; --tag-b: #E8927C;
  --danger: #D4736C; --danger-bg: #FFF0EE;
  --shadow: 0 2px 12px rgba(92,74,58,0.06);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Noto Sans JP', 'Hiragino Maru Gothic Pro', sans-serif;
  background: var(--cream); color: var(--brown);
  max-width: 540px; margin: 0 auto; min-height: 100vh;
  -webkit-text-size-adjust: 100%;
}
button { font-family: inherit; cursor: pointer; -webkit-tap-highlight-color: transparent; }
input, textarea { font-family: inherit; }

@keyframes pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(212,115,108,0.4); }
  50% { box-shadow: 0 0 0 14px rgba(212,115,108,0); }
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}
.fade-in { animation: fadeIn 0.3s ease; }

.header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 16px;
  background: linear-gradient(135deg, #5BA88C 0%, #6DB89C 100%);
  color: #fff; position: sticky; top: 0; z-index: 10;
  border-radius: 0 0 20px 20px;
  box-shadow: 0 4px 20px rgba(91,168,140,0.2);
}
.header-title { font-size: 17px; font-weight: 700; letter-spacing: 0.5px; }
.hdr-btn {
  background: rgba(255,255,255,0.2); border: none; color: #fff;
  font-size: 15px; padding: 6px 14px; border-radius: 20px; font-weight: 600;
}

.card {
  background: var(--white); border-radius: 20px; padding: 18px;
  margin-bottom: 14px; box-shadow: var(--shadow); border: 1px solid var(--brown-pale);
}
.card-title { font-weight: 700; font-size: 16px; margin-bottom: 4px; }
.card-meta { font-size: 13px; color: var(--brown-light); }
.card-actions { display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap; }

.btn-primary {
  width: 100%; padding: 18px; font-size: 17px; font-weight: 700;
  background: linear-gradient(135deg, #5BA88C, #6DB89C); color: #fff;
  border: none; border-radius: 20px;
  box-shadow: 0 4px 16px rgba(91,168,140,0.25); margin-bottom: 24px;
}
.btn-small { padding: 9px 14px; font-size: 13px; font-weight: 600; border: none; border-radius: 14px; }
.btn-pill { flex: 1; padding: 14px; font-size: 16px; font-weight: 700; border: none; border-radius: 14px; }
.btn-circle {
  display: flex; align-items: center; justify-content: center;
  border-radius: 50%; flex-shrink: 0; border: none; transition: background 0.25s;
}

/* ---- Chat layout: fixed header + speaker bar, scrollable messages, fixed input ---- */
.chat-fixed-top {
  position: sticky; top: 0; z-index: 10;
}
.speaker-bar {
  display: flex; padding: 10px 12px 6px; gap: 10px;
  background: var(--cream);
  border-bottom: 1px solid var(--brown-pale);
}
.speaker-btn {
  flex: 1; padding: 14px 0; font-size: 16px; font-weight: 700;
  border-radius: 16px; border: 2px solid var(--brown-pale);
  background: transparent; color: var(--brown-light);
  transition: all 0.25s ease;
}
.speaker-btn.active-a {
  border: 3px solid var(--tag-a); background: var(--mint-med);
  color: var(--tag-a); box-shadow: 0 2px 12px rgba(91,168,140,0.13);
}
.speaker-btn.active-b {
  border: 3px solid var(--tag-b); background: var(--coral-light);
  color: var(--tag-b); box-shadow: 0 2px 12px rgba(232,146,124,0.13);
}

.messages { flex: 1; overflow-y: auto; padding: 12px 14px 8px; background: var(--cream); }
.msg { display: flex; flex-direction: column; margin-bottom: 14px; }
.msg.left { align-items: flex-start; }
.msg.right { align-items: flex-end; }
.msg-meta { font-size: 11px; color: var(--brown-light); margin-bottom: 3px; }
.msg.left .msg-meta { padding-left: 6px; }
.msg.right .msg-meta { padding-right: 6px; }
.msg-bubble {
  padding: 12px 16px; max-width: 82%; line-height: 1.7;
  word-break: break-word; box-shadow: 0 1px 4px rgba(0,0,0,0.04);
}
.msg.left .msg-bubble { background: var(--bubble-a); border-radius: 6px 20px 20px 20px; }
.msg.right .msg-bubble { background: var(--bubble-b); border-radius: 20px 6px 20px 20px; }
.msg-stamp { font-size: 48px; line-height: 1.2; }

.input-area {
  padding: 10px 14px; padding-bottom: max(10px, env(safe-area-inset-bottom));
  background: var(--white); border-top: 1px solid var(--brown-pale);
}
.input-label { font-size: 12px; font-weight: 700; margin-bottom: 8px; text-align: center; }
.input-row { display: flex; gap: 8px; align-items: flex-end; }
.input-text {
  flex: 1; padding: 10px 14px; font-size: 16px; border-radius: 18px;
  border: 2px solid var(--brown-pale); outline: none; resize: none;
  line-height: 1.5; transition: all 0.25s;
}
.input-text.listening-a { border-color: var(--tag-a); background: var(--mint-med); }
.input-text.listening-b { border-color: var(--tag-b); background: var(--coral-light); }

.quick-bar {
  display: flex; flex-wrap: wrap; gap: 8px; padding: 10px 14px;
  background: var(--white); border-top: 1px solid var(--brown-pale);
}
.quick-btn {
  padding: 9px 16px; font-size: 14px; border-radius: 20px;
  background: transparent; font-weight: 600;
}

/* Stamp picker */
.stamp-bar {
  display: none; padding: 10px 14px; background: var(--white);
  border-top: 1px solid var(--brown-pale);
}
.stamp-bar.active { display: block; }
.stamp-grid {
  display: grid; grid-template-columns: repeat(6, 1fr); gap: 6px;
  max-height: 180px; overflow-y: auto;
}
.stamp-item {
  font-size: 28px; padding: 8px 0; text-align: center;
  border-radius: 12px; border: none; background: transparent;
  cursor: pointer; transition: background 0.15s;
}
.stamp-item:hover, .stamp-item:active { background: var(--brown-pale); }

.empty { text-align: center; padding: 48px 20px; color: var(--brown-light); }

.setting-group { margin-bottom: 16px; }
.setting-label { font-size: 13px; color: var(--brown-light); margin-bottom: 6px; font-weight: 600; }
.setting-input {
  width: 100%; padding: 13px; font-size: 16px; border-radius: 14px;
  border: 2px solid var(--brown-pale); outline: none;
}
.size-bar { display: flex; gap: 10px; }
.size-btn {
  flex: 1; padding: 14px; font-size: 16px; font-weight: 700;
  border-radius: 14px; transition: all 0.2s;
}
.size-btn.active { border: 3px solid var(--mint-dark); background: var(--mint-med); color: var(--mint-dark); }
.size-btn:not(.active) { border: 2px solid var(--brown-pale); background: transparent; color: var(--brown); }
.preview { margin-top: 14px; padding: 14px; background: var(--cream); border-radius: 14px; line-height: 1.6; }
.info-note {
  font-size: 13px; color: var(--brown-light); margin-top: 14px;
  padding: 10px 14px; background: var(--peach); border-radius: 12px;
}

.screen { display: none; }
.screen.active { display: flex; flex-direction: column; }
.screen-home.active { display: block; }
.screen-settings.active { display: block; }
.screen-chat.active { display: flex; height: 100vh; height: 100dvh; }

.new-form {
  background: var(--white); border-radius: 20px; padding: 20px;
  margin-bottom: 24px; border: 2px solid var(--mint-dark); box-shadow: var(--shadow);
}
.new-form-title { font-weight: 700; font-size: 16px; margin-bottom: 10px; }
.new-form-input {
  width: 100%; padding: 14px; font-size: 16px;
  border: 2px solid var(--brown-pale); border-radius: 14px; outline: none;
}
.new-form-actions { display: flex; gap: 10px; margin-top: 14px; }

.export-modal-overlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.4); z-index: 100;
  justify-content: center; align-items: center;
}
.export-modal-overlay.active { display: flex; }
.export-modal {
  background: var(--white); border-radius: 24px; padding: 24px;
  margin: 20px; max-width: 400px; width: 100%; box-shadow: 0 8px 32px rgba(0,0,0,0.15);
}
.export-modal h3 { margin-bottom: 16px; font-size: 18px; }
.export-btn {
  width: 100%; padding: 16px; font-size: 16px; font-weight: 700;
  border: none; border-radius: 14px; margin-bottom: 10px;
}
</style>
</head>
<body>

<!-- HOME -->
<div id="screen-home" class="screen screen-home active">
  <div class="header">
    <div style="width:64px"></div>
    <span class="header-title">ğŸ€ ä¼šè©±ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼</span>
    <button class="hdr-btn" onclick="showScreen('settings')">âš™ è¨­å®š</button>
  </div>
  <div style="padding:20px 16px">
    <button id="btn-new-session" class="btn-primary" onclick="showNewForm()">ï¼‹ æ–°ã—ã„ä¼šè©±ã‚’å§‹ã‚ã‚‹</button>
    <div id="new-form" class="new-form fade-in" style="display:none">
      <p class="new-form-title">ã‚»ãƒƒã‚·ãƒ§ãƒ³å</p>
      <input id="new-label" class="new-form-input" placeholder="ä¾‹ï¼šç”°ä¸­ã•ã‚“ 2/6" onkeydown="if(event.key==='Enter')createSession()">
      <div class="new-form-actions">
        <button class="btn-pill" style="background:var(--mint-dark);color:#fff" onclick="createSession()">ä½œæˆ</button>
        <button class="btn-pill" style="background:var(--brown-pale);color:var(--brown)" onclick="hideNewForm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
    <div id="session-list"></div>
  </div>
</div>

<!-- CHAT -->
<div id="screen-chat" class="screen screen-chat">
  <!-- Fixed top area: header + speaker toggle -->
  <div class="chat-fixed-top">
    <div class="header" style="border-radius:0">
      <button class="hdr-btn" onclick="backToHome()">â† æˆ»ã‚‹</button>
      <span class="header-title" id="chat-title"></span>
      <div style="display:flex;gap:6px">
        <button class="hdr-btn" style="font-size:13px" onclick="copyExport()" id="btn-copy-header">ğŸ“‹</button>
        <button class="hdr-btn" style="font-size:13px" onclick="downloadExport()">ğŸ“¥</button>
      </div>
    </div>
    <div class="speaker-bar">
      <button id="sp-btn-a" class="speaker-btn active-a" onclick="setSpeaker('A')">ğŸ…° <span id="sp-label-a">ã‚¹ã‚¿ãƒƒãƒ•</span></button>
      <button id="sp-btn-b" class="speaker-btn" onclick="setSpeaker('B')">ğŸ…± <span id="sp-label-b">ç›¸æ‰‹</span></button>
    </div>
  </div>

  <!-- Scrollable messages -->
  <div class="messages" id="messages">
    <div class="empty" id="msg-empty">
      <p style="font-size:36px;margin-bottom:8px">ğŸŒ¿</p>
      <p style="font-weight:600;font-size:15px">ä¼šè©±ã‚’å§‹ã‚ã¾ã—ã‚‡ã†</p>
      <p style="font-size:13px">è©±è€…ã‚’é¸ã‚“ã§ã€éŸ³å£° ğŸ¤ ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆã§å…¥åŠ›</p>
    </div>
  </div>

  <!-- Quick replies -->
  <div id="quick-bar" class="quick-bar" style="display:none"></div>

  <!-- Stamp picker -->
  <div id="stamp-bar" class="stamp-bar">
    <div class="stamp-grid" id="stamp-grid"></div>
  </div>

  <!-- Input area (fixed bottom) -->
  <div class="input-area">
    <div class="input-label" id="input-label" style="color:var(--tag-a)">â— ã‚¹ã‚¿ãƒƒãƒ• ãŒå…¥åŠ›ä¸­</div>
    <div class="input-row">
      <button class="btn-circle" id="btn-quick" onclick="toggleQuick()"
        style="width:42px;height:42px;border:2px solid var(--brown-pale);background:transparent;font-size:16px">ğŸ’¬</button>
      <button class="btn-circle" id="btn-stamp" onclick="toggleStamp()"
        style="width:42px;height:42px;border:2px solid var(--brown-pale);background:transparent;font-size:16px">ğŸ˜Š</button>
      <textarea id="input-text" class="input-text" placeholder="ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›..." rows="2"
        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage()}"></textarea>
      <button class="btn-circle" id="btn-mic" onclick="toggleMic()"
        style="width:50px;height:50px;background:var(--tag-a);color:#fff;font-size:22px">ğŸ¤</button>
      <button class="btn-circle" id="btn-send" onclick="sendMessage()"
        style="width:50px;height:50px;background:var(--brown-pale);color:#fff;font-size:20px">â†‘</button>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div id="screen-settings" class="screen screen-settings">
  <div class="header">
    <button class="hdr-btn" onclick="showScreen('home')">â† æˆ»ã‚‹</button>
    <span class="header-title">âš™ è¨­å®š</span>
    <div style="width:64px"></div>
  </div>
  <div style="padding:20px 16px">
    <div class="card" style="padding:20px">
      <h3 style="margin-bottom:16px;font-size:16px;font-weight:700">è©±è€…ã®åå‰</h3>
      <div class="setting-group">
        <div class="setting-label">ğŸ…° è©±è€…A</div>
        <input id="set-speaker-a" class="setting-input" oninput="updateSpeakerNames()">
      </div>
      <div class="setting-group" style="margin-bottom:0">
        <div class="setting-label">ğŸ…± è©±è€…B</div>
        <input id="set-speaker-b" class="setting-input" oninput="updateSpeakerNames()">
      </div>
    </div>
    <div class="card" style="padding:20px">
      <h3 style="margin-bottom:16px;font-size:16px;font-weight:700">æ–‡å­—ã‚µã‚¤ã‚º</h3>
      <div class="size-bar" id="size-bar"></div>
      <p class="preview" id="size-preview">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼šã“ã®å¤§ãã•ã§è¡¨ç¤ºã•ã‚Œã¾ã™</p>
    </div>
    <div class="card" style="padding:20px">
      <h3 style="margin-bottom:12px;font-size:16px;font-weight:700">ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</h3>
      <p style="font-size:14px;color:var(--brown-light);line-height:1.9">
        è´è¦šéšœå®³è€…ã¨å¥å¸¸è€…ã®å¯¾é¢ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ”¯æ´ã™ã‚‹ãƒãƒ£ãƒƒãƒˆã‚¢ãƒ—ãƒªã§ã™ã€‚éŸ³å£°å…¥åŠ›ã¨ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚’åˆ‡ã‚Šæ›¿ãˆãªãŒã‚‰ã€è‡ªç„¶ãªä¼šè©±ã‚’è¡Œãˆã¾ã™ã€‚
      </p>
      <p style="font-size:14px;color:var(--brown-light);line-height:1.9;margin-top:10px">
        ä¼šè©±ãƒ­ã‚°ã¯ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãã€è³ªçš„ç ”ç©¶ã®ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã—ã¦ã‚‚æ´»ç”¨ã§ãã¾ã™ã€‚
      </p>
      <p class="info-note">ğŸ’¡ éŸ³å£°èªè­˜ã«ã¯Chromeãƒ–ãƒ©ã‚¦ã‚¶ã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒå¿…è¦ã§ã™</p>
    </div>
  </div>
</div>

<!-- EXPORT MODAL -->
<div id="export-modal" class="export-modal-overlay" onclick="if(event.target===this)closeExportModal()">
  <div class="export-modal fade-in">
    <h3>ğŸ“¤ ä¼šè©±ãƒ­ã‚°ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
    <button class="export-btn" style="background:var(--mint-dark);color:#fff" onclick="downloadExport()">ğŸ“¥ ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜</button>
    <button class="export-btn" style="background:var(--mint-med);color:var(--mint-dark)" onclick="copyExport()">ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼</button>
    <div id="export-status" style="text-align:center;font-size:14px;color:var(--mint-dark);min-height:24px;margin-bottom:6px"></div>
    <button class="export-btn" style="background:var(--brown-pale);color:var(--brown)" onclick="closeExportModal()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
const APP_KEY = "kaiwa_app_v3";
const QUICK_REPLIES = ["ã¯ã„", "ã„ã„ãˆ", "ã‚‚ã†ä¸€åº¦ãŠé¡˜ã„ã—ã¾ã™", "ã‚ã‹ã‚Šã¾ã—ãŸ", "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™"];
const FONT_SIZES = [{l:"å°",v:14},{l:"ä¸­",v:18},{l:"å¤§",v:22},{l:"ç‰¹å¤§",v:28}];

// 30 stamps
const STAMPS = [
  "ğŸ˜Š","ğŸ˜„","ğŸ˜‚","ğŸ¥¹","ğŸ˜¢","ğŸ˜­","ğŸ˜¤","ğŸ˜ ","ğŸ˜¨","ğŸ˜±",
  "ğŸ¤”","ğŸ¤—","ğŸ˜´","ğŸ¤’","ğŸ¤•","ğŸ‘","ğŸ‘","ğŸ‘‹","ğŸ™","ğŸ’ª",
  "â¤ï¸","â­","âœ…","âŒ","â­•","â“","ğŸ’¡","ğŸ”¥","ğŸŒ¸","ğŸ€"
];

let appData = loadData();
let currentSessionId = null;
let currentSpeaker = "A";
let isListening = false;
let recognition = null;
let showQuickState = false;
let showStampState = false;

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }
function timeStr() { return new Date().toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit",second:"2-digit"}); }
function dateStr() { return new Date().toLocaleDateString("ja-JP",{year:"numeric",month:"2-digit",day:"2-digit"}); }

function loadData() {
  try { return JSON.parse(localStorage.getItem(APP_KEY)) || defaultData(); }
  catch { return defaultData(); }
}
function defaultData() { return { sessions:[], settings:{fontSize:18, speakerA:"ã‚¹ã‚¿ãƒƒãƒ•", speakerB:"ç›¸æ‰‹"} }; }
function saveData() { try { localStorage.setItem(APP_KEY, JSON.stringify(appData)); } catch(e){} }

// â”€â”€ Screen â”€â”€
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + name).classList.add('active');
  if (name === 'home') renderSessionList();
  if (name === 'settings') renderSettings();
  if (name === 'chat') renderChat();
}

// â”€â”€ Home â”€â”€
function showNewForm() {
  document.getElementById('btn-new-session').style.display = 'none';
  document.getElementById('new-form').style.display = 'block';
  document.getElementById('new-label').value = '';
  document.getElementById('new-label').focus();
}
function hideNewForm() {
  document.getElementById('btn-new-session').style.display = 'block';
  document.getElementById('new-form').style.display = 'none';
}
function createSession() {
  const label = document.getElementById('new-label').value.trim();
  if (!label) return;
  const s = { id: uid(), label, createdAt: new Date().toISOString(), messages: [] };
  appData.sessions.unshift(s);
  saveData();
  hideNewForm();
  currentSessionId = s.id;
  currentSpeaker = "A";
  showScreen('chat');
}
function deleteSession(id) {
  appData.sessions = appData.sessions.filter(s => s.id !== id);
  saveData();
  renderSessionList();
}
let deleteConfirmId = null;
function confirmDelete(id) { deleteConfirmId = id; renderSessionList(); }

function renderSessionList() {
  const el = document.getElementById('session-list');
  if (appData.sessions.length === 0) {
    el.innerHTML = `<div class="empty"><p style="font-size:48px;margin-bottom:8px">ğŸŒ±</p><p style="font-weight:600">ã¾ã ä¼šè©±ãŒã‚ã‚Šã¾ã›ã‚“</p><p style="font-size:14px">ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰å§‹ã‚ã¦ã¿ã¾ã—ã‚‡ã†</p></div>`;
    return;
  }
  el.innerHTML = appData.sessions.map(s => `
    <div class="card fade-in">
      <div onclick="openSession('${s.id}')" style="cursor:pointer">
        <div class="card-title">${esc(s.label)}</div>
        <div class="card-meta">${new Date(s.createdAt).toLocaleString("ja-JP")}ã€€Â·ã€€${s.messages.length} ä»¶</div>
      </div>
      <div class="card-actions">
        <button class="btn-small" style="background:var(--mint-med);color:var(--mint-dark)" onclick="openSession('${s.id}')">â–¶ é–‹ã</button>
        <button class="btn-small" style="background:var(--peach);color:var(--coral)" onclick="openExportModal('${s.id}')">ğŸ“¤ å‡ºåŠ›</button>
        ${deleteConfirmId === s.id
          ? `<button class="btn-small" style="background:var(--danger);color:#fff;font-weight:700" onclick="deleteSession('${s.id}')">æœ¬å½“ã«å‰Šé™¤</button>`
          : `<button class="btn-small" style="background:var(--danger-bg);color:var(--danger)" onclick="confirmDelete('${s.id}')">ğŸ—‘ å‰Šé™¤</button>`}
      </div>
    </div>`).join('');
}
function openSession(id) { currentSessionId = id; currentSpeaker = "A"; showScreen('chat'); }

// â”€â”€ Chat â”€â”€
function getSession() { return appData.sessions.find(s => s.id === currentSessionId); }

function renderChat() {
  const ses = getSession();
  if (!ses) return;
  const st = appData.settings;
  document.getElementById('chat-title').textContent = ses.label;
  document.getElementById('sp-label-a').textContent = st.speakerA;
  document.getElementById('sp-label-b').textContent = st.speakerB;
  setSpeaker(currentSpeaker);
  renderMessages();
  renderQuickBar();
  renderStampGrid();
  updateInputText();
}

function setSpeaker(sp) {
  currentSpeaker = sp;
  const st = appData.settings;
  document.getElementById('sp-btn-a').className = 'speaker-btn' + (sp === 'A' ? ' active-a' : '');
  document.getElementById('sp-btn-b').className = 'speaker-btn' + (sp === 'B' ? ' active-b' : '');
  const accent = sp === 'A' ? 'var(--tag-a)' : 'var(--tag-b)';
  const name = sp === 'A' ? st.speakerA : st.speakerB;
  document.getElementById('input-label').textContent = 'â— ' + name + ' ãŒå…¥åŠ›ä¸­';
  document.getElementById('input-label').style.color = accent;
  document.getElementById('btn-mic').style.background = isListening ? 'var(--danger)' : accent;
  updateSendBtn();
  renderQuickBar();
}

function renderMessages() {
  const ses = getSession();
  const el = document.getElementById('messages');
  const st = appData.settings;
  const fontSize = st.fontSize + 'px';

  if (ses.messages.length === 0) {
    document.getElementById('msg-empty').style.display = 'block';
    el.querySelectorAll('.msg').forEach(m => m.remove());
    return;
  }
  document.getElementById('msg-empty').style.display = 'none';
  el.querySelectorAll('.msg').forEach(m => m.remove());

  ses.messages.forEach(m => {
    const isA = m.speaker === 'A';
    const name = isA ? st.speakerA : st.speakerB;
    const div = document.createElement('div');
    div.className = 'msg fade-in ' + (isA ? 'left' : 'right');

    const isStamp = m.type === 'stamp';
    div.innerHTML = `
      <div class="msg-meta">${esc(name)}ã€€${m.time}</div>
      ${isStamp
        ? `<div class="msg-stamp">${m.text}</div>`
        : `<div class="msg-bubble" style="font-size:${fontSize}">${esc(m.text)}</div>`
      }
    `;
    el.appendChild(div);
  });
  requestAnimationFrame(() => el.scrollTop = el.scrollHeight);
}

function sendMessage() {
  const input = document.getElementById('input-text');
  const text = input.value.trim();
  if (!text) return;
  stopMic();
  const ses = getSession();
  ses.messages.push({ id: uid(), speaker: currentSpeaker, text, time: timeStr(), date: dateStr(), type: 'text' });
  saveData();
  input.value = '';
  renderMessages();
  updateSendBtn();
  input.focus();
}

function sendStamp(emoji) {
  const ses = getSession();
  ses.messages.push({ id: uid(), speaker: currentSpeaker, text: emoji, time: timeStr(), date: dateStr(), type: 'stamp' });
  saveData();
  renderMessages();
  // Keep stamp picker open for easy multiple sends
}

function updateSendBtn() {
  const text = document.getElementById('input-text').value.trim();
  const accent = currentSpeaker === 'A' ? 'var(--tag-a)' : 'var(--tag-b)';
  const btn = document.getElementById('btn-send');
  btn.style.background = text ? accent : 'var(--brown-pale)';
  btn.style.cursor = text ? 'pointer' : 'default';
}

function updateInputText() {
  document.getElementById('input-text').oninput = () => updateSendBtn();
  updateSendBtn();
}

// â”€â”€ Quick Replies â”€â”€
function toggleQuick() {
  showQuickState = !showQuickState;
  showStampState = false;
  document.getElementById('quick-bar').style.display = showQuickState ? 'flex' : 'none';
  document.getElementById('stamp-bar').classList.remove('active');
  document.getElementById('btn-quick').style.background = showQuickState ? 'var(--mint-med)' : 'transparent';
  document.getElementById('btn-stamp').style.background = 'transparent';
}
function renderQuickBar() {
  const bar = document.getElementById('quick-bar');
  const accent = currentSpeaker === 'A' ? 'var(--tag-a)' : 'var(--tag-b)';
  bar.innerHTML = QUICK_REPLIES.map(q =>
    `<button class="quick-btn" style="border:2px solid ${accent};color:${accent}" onclick="quickReply('${esc(q)}')">${esc(q)}</button>`
  ).join('');
}
function quickReply(text) {
  const ses = getSession();
  ses.messages.push({ id: uid(), speaker: currentSpeaker, text, time: timeStr(), date: dateStr(), type: 'text' });
  saveData();
  showQuickState = false;
  document.getElementById('quick-bar').style.display = 'none';
  document.getElementById('btn-quick').style.background = 'transparent';
  renderMessages();
}

// â”€â”€ Stamp Picker â”€â”€
function toggleStamp() {
  showStampState = !showStampState;
  showQuickState = false;
  document.getElementById('stamp-bar').classList.toggle('active', showStampState);
  document.getElementById('quick-bar').style.display = 'none';
  document.getElementById('btn-stamp').style.background = showStampState ? 'var(--mint-med)' : 'transparent';
  document.getElementById('btn-quick').style.background = 'transparent';
}
function renderStampGrid() {
  const grid = document.getElementById('stamp-grid');
  grid.innerHTML = STAMPS.map(s =>
    `<button class="stamp-item" onclick="sendStamp('${s}')">${s}</button>`
  ).join('');
}

// â”€â”€ Speech Recognition â”€â”€
function toggleMic() { isListening ? stopMic() : startMic(); }

function startMic() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) { alert('éŸ³å£°èªè­˜ã¯Chromeãƒ–ãƒ©ã‚¦ã‚¶ã§åˆ©ç”¨ã§ãã¾ã™'); return; }
  stopMic();
  recognition = new SR();
  recognition.lang = 'ja-JP';
  recognition.interimResults = true;
  recognition.continuous = true;
  const input = document.getElementById('input-text');
  let finalText = input.value;
  recognition.onresult = (e) => {
    let interim = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      if (e.results[i].isFinal) finalText += e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    input.value = finalText + interim;
    updateSendBtn();
  };
  recognition.onerror = () => stopMic();
  recognition.onend = () => { isListening = false; updateMicUI(); recognition = null; };
  recognition.start();
  isListening = true;
  updateMicUI();
}

function stopMic() {
  if (recognition) { recognition.stop(); recognition = null; }
  isListening = false;
  updateMicUI();
}

function updateMicUI() {
  const btn = document.getElementById('btn-mic');
  const input = document.getElementById('input-text');
  const accent = currentSpeaker === 'A' ? 'var(--tag-a)' : 'var(--tag-b)';
  if (isListening) {
    btn.style.background = 'var(--danger)';
    btn.innerHTML = 'â¹';
    btn.style.animation = 'pulse 1.5s infinite';
    input.classList.add(currentSpeaker === 'A' ? 'listening-a' : 'listening-b');
    input.classList.remove(currentSpeaker === 'A' ? 'listening-b' : 'listening-a');
  } else {
    btn.style.background = accent;
    btn.innerHTML = 'ğŸ¤';
    btn.style.animation = 'none';
    input.classList.remove('listening-a', 'listening-b');
  }
}

function backToHome() { stopMic(); showScreen('home'); }

// â”€â”€ Export â”€â”€
let exportSessionId = null;
function openExportModal(id) {
  exportSessionId = id || currentSessionId;
  document.getElementById('export-modal').classList.add('active');
  document.getElementById('export-status').textContent = '';
}
function closeExportModal() {
  document.getElementById('export-modal').classList.remove('active');
  exportSessionId = null;
}
function buildExportText(ses) {
  const st = appData.settings;
  let o = `ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼š${ses.label}\n`;
  o += `ä½œæˆæ—¥æ™‚ï¼š${new Date(ses.createdAt).toLocaleString("ja-JP")}\n`;
  o += `è©±è€…Aï¼š${st.speakerA}ã€€ï¼ã€€è©±è€…Bï¼š${st.speakerB}\n`;
  o += `${"â”€".repeat(40)}\n\n`;
  ses.messages.forEach(m => {
    const nm = m.speaker === "A" ? st.speakerA : st.speakerB;
    const label = m.type === 'stamp' ? 'ã€ã‚¹ã‚¿ãƒ³ãƒ—ã€‘' : '';
    o += `[${m.date} ${m.time}] ${nm}ï¼ˆè©±è€…${m.speaker}ï¼‰: ${label}${m.text}\n`;
  });
  o += `\n${"â”€".repeat(40)}\n`;
  o += `ç·ç™ºè©±æ•°ï¼š${ses.messages.length}\n`;
  o += `è©±è€…Aï¼ˆ${st.speakerA}ï¼‰ï¼š${ses.messages.filter(m=>m.speaker==="A").length} ä»¶\n`;
  o += `è©±è€…Bï¼ˆ${st.speakerB}ï¼‰ï¼š${ses.messages.filter(m=>m.speaker==="B").length} ä»¶\n`;
  return o;
}
function getExportSession() { return appData.sessions.find(s => s.id === (exportSessionId || currentSessionId)); }

function downloadExport() {
  const ses = getExportSession();
  if (!ses) return;
  const txt = buildExportText(ses);
  const blob = new Blob([txt], {type:"text/plain;charset=utf-8"});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `ä¼šè©±ãƒ­ã‚°_${ses.label}_${dateStr().replace(/\//g,"")}.txt`;
  a.click();
  URL.revokeObjectURL(a.href);
  document.getElementById('export-status').textContent = 'âœ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ';
}
async function copyExport() {
  const ses = getExportSession();
  if (!ses) return;
  try {
    await navigator.clipboard.writeText(buildExportText(ses));
    document.getElementById('export-status').textContent = 'âœ“ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
    const hb = document.getElementById('btn-copy-header');
    if (hb) { hb.textContent = 'âœ“'; setTimeout(() => hb.textContent = 'ğŸ“‹', 2000); }
  } catch {
    document.getElementById('export-status').textContent = 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ';
  }
}

// â”€â”€ Settings â”€â”€
function renderSettings() {
  const st = appData.settings;
  document.getElementById('set-speaker-a').value = st.speakerA;
  document.getElementById('set-speaker-b').value = st.speakerB;
  renderSizeBar();
  document.getElementById('size-preview').style.fontSize = st.fontSize + 'px';
}
function updateSpeakerNames() {
  appData.settings.speakerA = document.getElementById('set-speaker-a').value || "è©±è€…A";
  appData.settings.speakerB = document.getElementById('set-speaker-b').value || "è©±è€…B";
  saveData();
}
function renderSizeBar() {
  document.getElementById('size-bar').innerHTML = FONT_SIZES.map(f =>
    `<button class="size-btn ${appData.settings.fontSize===f.v?'active':''}" onclick="setFontSize(${f.v})">${f.l}</button>`
  ).join('');
}
function setFontSize(v) {
  appData.settings.fontSize = v; saveData(); renderSizeBar();
  document.getElementById('size-preview').style.fontSize = v + 'px';
}

// â”€â”€ Util â”€â”€
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

// â”€â”€ Init â”€â”€
renderSessionList();
</script>
</body>
</html>
